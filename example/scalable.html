<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Alloy Render Engine</title>
</head>
    
<body>   
     <a href="https://github.com/AlloyTeam/AlloyRenderingEngine" target="_blank" style="position:absolute;right:0;top:0;z-index:1000;">
<img src="http://alloyteam.github.io/AlloyRenderingEngine/asset/img/github.png" alt="" />
 </a>
    <div style="text-align: center;position:absolute;z-index:1000;">
        <input id="range1" type="range" name="range" min="0" max="1" step="0.1" value="1" />
         <input id="range2" type="range" name="range" min="0" max="1" step="0.1" value="1" />
    </div>
    
      <canvas  width="1040" id="ourCanvas" height="1040"></canvas>
    <script>
        (function (n, t) { typeof onTileMapLoaded == "undefined" ? (typeof TileMaps == "undefined" && (TileMaps = {}), TileMaps[n] = t) : onTileMapLoaded(n, t) })("map1", { height: 20, layers: [{ data: [4, 4, 1, 2, 3, 2, 2, 4, 3, 3, 2, 1, 2, 2, 3, 3, 4, 1, 1, 1, 2, 4, 8, 8, 8, 8, 8, 8, 1, 1, 3, 4, 8, 8, 8, 8, 8, 4, 4, 3, 4, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 4, 3, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 2, 2, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7, 7, 7, 8, 8, 8, 4, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7, 8, 8, 8, 1, 1, 8, 8, 5, 5, 5, 5, 8, 8, 8, 8, 8, 8, 8, 8, 7, 8, 8, 8, 1, 2, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 2, 2, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 4, 4, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 4, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 2, 1, 4, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 1, 1, 1, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5, 8, 8, 8, 8, 8, 3, 1, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5, 8, 8, 8, 8, 8, 2, 3, 3, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 5, 8, 8, 8, 8, 8, 1, 1, 4, 8, 8, 7, 7, 8, 8, 8, 8, 8, 8, 8, 5, 5, 5, 8, 8, 8, 3, 4, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 4, 2, 3, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 1, 3, 1, 1, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 4, 2, 2, 1, 4, 4, 4, 2, 1, 1, 3, 3, 3, 4, 1, 2, 2, 3, 2, 4, 2, 4, 2, 2], height: 20, name: "map1", opacity: 1, type: "tilelayer", visible: !0, width: 20, x: 0, y: 0 }, { draworder: "topdown", height: 20, name: "obj1", objects: [{ gid: 13, height: 0, id: 1, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 519.666666666667, y: 392.333333333333 }, { gid: 13, height: 0, id: 4, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 383.666666666667, y: 713.666666666667 }, { height: 0, id: 5, name: "", polygon: [{ x: 0, y: 0 }, { x: 21.3333333333334, y: 24 }, { x: 76, y: 0 }, { x: 120, y: 18.6666666666667 }, { x: 114.666666666667, y: 84 }, { x: 68.0000000000001, y: 57.3333333333334 }, { x: 4, y: 84 }, { x: 1.33333333333337, y: 49.3333333333334 }, { x: -20, y: 28 }, { x: 5.33333333333337, y: 32 }], properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 398.666666666667, y: 629.333333333333 }, { height: 0, id: 9, name: "", polygon: [{ x: 0, y: 0 }, { x: 21.3333, y: 24 }, { x: 76, y: 0 }, { x: 120, y: 18.6667 }, { x: 114.667, y: 84 }, { x: 68, y: 57.3333 }, { x: 4, y: 84 }, { x: 1.33333, y: 49.3333 }, { x: -20, y: 28 }, { x: 5.33333, y: 32 }], properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 536, y: 306.666666666667 }, { gid: 15, height: 0, id: 14, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 392.333333333333, y: 559.666666666667 }, { ellipse: !0, height: 33.3333333333333, id: 15, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 33.3333333333333, x: 393.333333333333, y: 525.333333333333 }, { gid: 15, height: 0, id: 16, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 644, y: 516 }, { ellipse: !0, height: 33.3333, id: 17, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 33.3333, x: 646.000016666667, y: 482.000016666667 }, { gid: 14, height: 0, id: 18, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 212.333333333333, y: 450.333333333333 }, { gid: 14, height: 0, id: 19, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 197.666666666667, y: 586.333333333333 }, { height: 32, id: 21, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 33.3333333333333, x: 213.333333333333, y: 416 }, { height: 33.3333333333334, id: 22, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 33.3333333333333, x: 198.666666666667, y: 550.666666666667 }, { height: 0, id: 25, name: "", polygon: [{ x: 0, y: 0 }, { x: 1, y: 313 }, { x: 53, y: 314 }, { x: 53, y: 727 }, { x: 156, y: 730 }, { x: 156, y: 782 }, { x: 783, y: 782 }, { x: 782, y: 728 }, { x: 886, y: 728 }, { x: 885, y: 678 }, { x: 937, y: 677 }, { x: 938, y: 415 }, { x: 887, y: 416 }, { x: 885, y: 156 }, { x: 937, y: 156 }, { x: 938, y: -52 }, { x: 885, y: -53 }, { x: 886, y: -103 }, { x: 834, y: -105 }, { x: 834, y: -157 }, { x: 571, y: -156 }, { x: 573, y: -105 }, { x: 365, y: -104 }, { x: 366, y: -156 }, { x: 50, y: -156 }, { x: 52, y: -1 }], properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 50, y: 207 }, { height: 50.6666666666667, id: 26, name: "", properties: {}, rotation: 0, type: "", visible: !0, width: 206.666666666667, x: 154.666666666667, y: 310.666666666667 }, { height: 0, id: 29, name: "", polygon: [{ x: 0, y: 0 }, { x: 0, y: 50.6666666666666 }, { x: 104, y: 52 }, { x: 104, y: 152 }, { x: 153.333333333333, y: 152 }, { x: 156, y: 0 }], properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 676, y: 208 }, { height: 0, id: 31, name: "", polygon: [{ x: 0, y: 0 }, { x: 49.3333333333334, y: 0 }, { x: 50.6666666666667, y: 154.666666666667 }, { x: 152, y: 153.333333333333 }, { x: 154.666666666667, y: 205.333333333333 }, { x: 0, y: 205.333333333333 }], properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 677.333333333333, y: 624 }, { height: 0, id: 32, name: "", polygon: [{ x: 0, y: 0 }, { x: 150.666666666667, y: 0 }, { x: 150.666666666667, y: 50.6666666666667 }, { x: 204, y: 52 }, { x: 204, y: 100 }, { x: 100, y: 101.333333333333 }, { x: 98.6666666666667, y: 52 }, { x: -2.66666666666666, y: 49.3333333333334 }], properties: {}, rotation: 0, type: "", visible: !0, width: 0, x: 106.666666666667, y: 729.333333333333 }], opacity: 1, type: "objectgroup", visible: !0, width: 20, x: 0, y: 0 }], nextobjectid: 33, orientation: "orthogonal", properties: {}, renderorder: "right-down", tileheight: 52, tilesets: [{ firstgid: 1, image: "map.png", imageheight: 208, imagewidth: 156, margin: 0, name: "map", properties: {}, spacing: 0, tileheight: 52, tilewidth: 52 }, { firstgid: 13, margin: 0, name: "block", properties: {}, spacing: 0, tileheight: 86, tiles: { "0": { image: "block1.png" }, "1": { image: "image1448.bmp" }, "2": { image: "image1490.png" } }, tilewidth: 135 }], tilewidth: 52, version: 1, width: 20 });
  !function(){var e=!1,n=/xyz/.test(function(){})?/\b_super\b/:/.*/,i=function(){};i.extend=function(t){function i(){!e&&this.ctor&&this.ctor.apply(this,arguments)}var a,o,s,r=this.prototype;e=!0,a=new this,e=!1;for(s in t)"statics"!=s&&(a[s]="function"==typeof t[s]&&"function"==typeof r[s]&&n.test(t[s])?function(t,e){return function(){var i,n=this._super;return this._super=r[t],i=e.apply(this,arguments),this._super=n,i}}(s,t[s]):t[s]);for(o in this)this.hasOwnProperty(o)&&"extend"!=o&&(i[o]=this[o]);if(i.prototype=a,t.statics)for(s in t.statics)t.statics.hasOwnProperty(s)&&(i[s]=t.statics[s],"ctor"==s&&i[s]());return i.prototype.constructor=i,i.extend=arguments.callee,i.implement=function(t){for(var e in t)a[e]=t[e]},i},function(){var t={},e={};t.DisplayObject=i.extend({ctor:function(){this.alpha=this.scaleX=this.scaleY=1,this.x=this.y=this.rotation=this.originX=this.originY=this.skewX=this.skewY=this.width=this.height=0,this.flipX=this.flipY=!1,this.visible=!0,this._matrix=new t.Matrix2D,this.events={},this.id=t.UID.get(),this.baseInstanceof="DisplayObject";var e=this;this._watch(this,"originX",function(t,n){e.regX=e.width*n}),this._watch(this,"originY",function(t,n){e.regY=e.height*n})},_watch:function(t,e,n){t["__"+e]=this[e];Object.defineProperty(t,e,{get:function(){return this["__"+e]},set:function(t){this["__"+e]=t,n(e,t)}})},isVisible:function(){return!!(this.visible&&this.alpha>0&&0!=this.scaleX&&0!=this.scaleY)},on:function(e,n){["mouseover","mousemove","mouseout","touchstart","touchmove","touchend"].join("_").match(e)&&(t.Stage.checkMove=!0),this.events[e]||(this.events[e]=[]),this.events[e].push(n)},execEvent:function(t){var e=this.events[t];this._fireFns(e)},hover:function(t,e){this.on("mouseover",t),this.on("mouseout",e)},_fireFns:function(t){if(t)for(var e=0,n=t.length;n>e;e++)t[e].call(this)},clone:function(){var e=new t.DisplayObject;return this.cloneProps(e),e},cloneProps:function(t){t.visible=this.visible,t.alpha=this.alpha,t.originX=this.originX,t.originY=this.originY,t.rotation=this.rotation,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.skewX=this.skewX,t.skewY=this.skewY,t.x=this.x,t.y=this.y,t.regX=this.regX,t.regY=this.regY},cache:function(e,n,i,r){if(!this.cacheCanvas){this.cacheCanvas=document.createElement("canvas");var a=this.getBound();this.cacheCanvas.width=a.width,this.cacheCanvas.height=a.height,this.cacheCtx=this.cacheCanvas.getContext("2d")}t.Stage.renderer.updateCache(this.cacheCtx,this,i,r)},uncache:function(){this.cacheCanvas=null,this.cacheCtx=null,this.cacheID=null},getBound:function(){return{width:this.width,height:this.height}},toCenter:function(){this.originX=.5,this.originY=.5,this.x=this.parent.width/2,this.y=this.parent.height/2},onClick:function(t){this.on("click",t)},onMouseMove:function(t){this.on("mousemove",t)}}),t.Container=t.DisplayObject.extend({ctor:function(){this._super(),this.children=[],this.baseInstanceof="Container"},add:function(t){var e=arguments.length;if(e>1)for(var n=0;e>n;n++){var i=arguments[n];i&&(this.children.push(i),i.parent=this)}else t&&(this.children.push(t),t.parent=this)},remove:function(t){var e=arguments.length,n=this.children.length;if(e>1){for(var i=0;e>i;i++)for(var r=arguments[i],a=n;--a>=0;)if(this.children[a].id==r.id){r.parent=null,this.children.splice(a,1);break}}else for(var o=n;--o>=0;)if(this.children[o].id==t.id){t.parent=null,this.children.splice(o,1);break}},clone:function(){var e=new t.Container;this.cloneProps(e);for(var n=e.children=[],i=this.children.length-1;i>-1;i--){var r=this.children[i].clone();n.unshift(r)}return e},removeAll:function(){for(var t=this.children;t.length;)t.pop().parent=null}}),e.Main=i.extend({ctor:function(){var e=new t.Loader,i=new t.Stage("#ourCanvas","1"==localStorage.webgl),r=this.generateResources("../asset/img/map/");r.push({id:"atLogo",src:"../asset/img/atLogo.png"}),e.loadRes(r);var a=document.querySelector("#range1"),o=document.querySelector("#range2");i.scalable(a.value,o.value),this.resIdMapping=this.generateResIdMapping();var s=this;e.complete(function(){s.renderTilelayer();var n=new t.Bitmap(e.get("atLogo"));n.on("click",function(){n.setFilter(Math.random(),Math.random(),Math.random(),1)}),i.add(n),n.toCenter();var r=.01;i.onTick(function(){n.rotation+=.5,(n.scaleX>1.5||n.scaleX<.5)&&(r*=-1),n.scaleX+=r,n.scaleY+=r}),a.addEventListener("mouseup",function(){i.scalable(a.value,o.value)},!1),o.addEventListener("mouseup",function(){i.scalable(a.value,o.value)},!1),a.addEventListener("change",function(){i.scalable(a.value,o.value)},!1),o.addEventListener("change",function(){i.scalable(a.value,o.value)},!1)}),this.ld=e,this.stage=i,this.tileWidth=TileMaps.map1.tilewidth,this.tileHeight=TileMaps.map1.tileheight,this.objects=TileMaps.map1.layers[1].objects},renderTilelayer:function(){for(var e=TileMaps.map1.layers[0].data,n=e.length,i=0;n>i;i++){var r=new t.Bitmap(this.ld.get("map")),a=e[i]-1;r.rect=[a%3*this.tileWidth,Math.floor(a/3)*this.tileHeight,this.tileWidth,this.tileHeight],r.x=i%20*this.tileWidth,r.y=Math.floor(i/20)*this.tileHeight,this.stage.add(r)}},renderObj:function(){for(var t=0,e=this.objects.length;e>t;t++){this.objects[t]}},renderPolygon:function(){},generateResources:function(t){this.tileSets=TileMaps.map1.tilesets;var e=[],n={},i=this.tileSets[0];n.id=i.name,n.src=t+i.image,e.push(n);for(var r=this.tileSets[1],a=0,o=r.tiles.length;o>a;a++){var s=r.tiles[a],c={};c.id=r.name+a,c.src=t+s.image,e.push(c)}return e},generateResIdMapping:function(){this.tileSets=TileMaps.map1.tilesets;for(var t={},e=this.tileSets[0],n=this.tileSets[1],i=n.firstgid,r=1;i>r;r++)t[r]=e.name;for(var a in n.tiles)if(n.tiles.hasOwnProperty(a)){{n.tiles[a]}t[i]=n.name+a,i++}return t}}),t.Stage=t.Container.extend({statics:{checkMove:!1},ctor:function(e,n){this._super(),this.canvas="string"==typeof e?document.querySelector(e):e,this.width=this.canvas.width,this.height=this.canvas.height;var r=(!!window.CanvasRenderingContext2D,function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(e){return!1}}());r&&!n?this.renderer=new t.WebGLRenderer(this):(this.ctx=this.canvas.getContext("2d"),this.renderer=new t.CanvasRenderer(this)),t.Stage.renderer=this.renderer,this.hitRenderer=new t.CanvasRenderer(this),this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=1,this.hitCanvas.height=1,this.hitCtx=this.hitCanvas.getContext("2d"),Function.prototype.bind=function(){var t=this,e=Array.prototype.slice.call(arguments),n=e.shift();return function(){return t.apply(n,e.concat(Array.prototype.slice.call(arguments)))}},this._scaleX=this._scaleY=null,this.canvas.addEventListener("click",this._handleClick.bind(this),!1),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this),!1),window.addEventListener("keydown",this._handleKeyDown.bind(this),!1),window.addEventListener("keyup",this._handleKeyUp.bind(this),!1),this.offset=this._getXY(this.canvas),this.overObj=null,this.pause=!1,this.interval=Math.floor(1e3/60);var a=this;a.loop=t.RAF.requestInterval(function(){a._tick(a)},a.interval)},update:function(){this.pause||this.renderer.update()},_handleKeyDown:function(t){this.keyDownCallback&&this.keyDownCallback(t.keyCode)},_handleKeyUp:function(t){this.keyUpCallback&&this.keyUpCallback(t.keyCode)},_handleClick:function(t){if(t.stageX=t.pageX-this.offset[0],t.stageY=t.pageY-this.offset[1],this._scaleX){var e=this.correctingXY(t.stageX,t.stageY);t.stageX=e.x,t.stageY=e.y}var n=this.events.click;if(n)for(var i=0,r=n.length;r>i;i++){var a=n[i];a(t)}this.hitRenderer.hitRender(this.hitCtx,this,null,t.stageX,t.stageY,"click")},_handleMouseMove:function(t){if(t.stageX=t.pageX-this.offset[0],t.stageY=t.pageY-this.offset[1],this._scaleX){var e=this.correctingXY(t.stageX,t.stageY);t.stageX=e.x,t.stageY=e.y}var n=this.events.mousemove;if(n)for(var i=0,r=n.length;r>i;i++){var a=n[i];a(t)}},_getXY:function(t){var e=0,n=0;if(!document.documentElement.getBoundingClientRect||!t.getBoundingClientRect){for(;t.offsetParent;)e+=t.offsetTop,n+=t.offsetLeft,t=t.offsetParent;return[n,e]}var i=t.getBoundingClientRect();return n=i.left,e=i.top,[n+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),e+Math.max(document.documentElement.scrollTop,document.body.scrollTop)]},destroy:function(){},_tick:function(t){if(t.tick)if(this._initInterval(t),t.hasOwnProperty("_tickInterval")){t._tickIntervalCurrent=new Date,t._tickIntervalLast||(t._tickIntervalLast=new Date);var e=t._tickIntervalCurrent-t._tickIntervalLast;e>t._tickInterval&&(t.tick(),t._tickIntervalLast=t._tickIntervalCurrent)}else t.tick();for(var n=t.children,i=n.length,r=0;i>r;r++){var a=n[r];if(a.tick)if(this._initInterval(a),a.hasOwnProperty("_tickInterval")){a._tickIntervalCurrent=new Date,a._tickIntervalLast||(a._tickIntervalLast=new Date);var e=a._tickIntervalCurrent-a._tickIntervalLast;e>a._tickInterval&&(a.tick(),a._tickIntervalLast=a._tickIntervalCurrent)}else a.tick();"Container"==a.baseInstanceof&&this._tick(a)}},_initInterval:function(t){t.hasOwnProperty("tickFPS")&&(t._tickInterval=0==t.tickFPS?1e4:1e3/t.tickFPS)},tick:function(){this.tickFn&&this.tickFn(),this.update()},onTick:function(t){this.tickFn=t},setFPS:function(t){this.interval=Math.floor(1e3/t)},onKeyDown:function(t){this.keyDownCallback=t},onKeyUp:function(t){this.keyUpCallback=t},onKeyboard:function(e,n,i){t.Keyboard.on(e,n,i)},getActiveKeys:function(){return t.Keyboard.getActiveKeys()},scalable:function(t,e){document.body.style.margin=0,document.documentElement.style.margin=0,document.body.style.border=0,document.documentElement.style.border=0,document.body.style.padding=0,document.documentElement.style.padding=0,document.body.style.width="100%",document.documentElement.style.width="100%",document.body.style.height="100%",document.documentElement.style.height="100%",this._scaleX=t,this._scaleY=e;var n=this.canvas;n.style.position="absolute",n.style.width=100*t+"%",n.style.height=100*e+"%",n.style.left=100*(1-t)/2+"%",n.style.top=100*(1-e)/2+"%",n.style.border="0px solid #ccc",this.offset=this._getXY(this.canvas)},correctingXY:function(t,e){return{x:t*this.canvas.width/(window.innerWidth*this._scaleX),y:e*this.canvas.height/(window.innerHeight*this._scaleY)}}}),t.Bitmap=t.DisplayObject.extend({ctor:function(t){if(this._super(),"string"==typeof t){var e=this;this.visible=!1,this.img=document.createElement("img"),this.img.onload=function(){e.visible=!0,e.rect||(e.rect=[0,0,e.img.width,e.img.height]),e.width=e.rect[2],e.height=e.rect[3],e.regX=e.width*e.originX,e.regY=e.height*e.originY},this.img.src=t}else this.img=t,this.rect=[0,0,t.width,t.height],this.width=t.width,this.height=t.height},setFilter:function(t,e,n,i){this.uncache(),this.cache();for(var r=this.cacheCtx.getImageData(0,0,this.cacheCanvas.width,this.cacheCanvas.height),a=r.data,o=0,s=a.length;s>o;o+=4)a[o+3]>0&&(a[o]*=t,a[o+1]*=e,a[o+2]*=n,a[o+3]*=i);this.cacheCtx.putImageData(r,0,0)},setRect:function(t,e,n,i){1===arguments.length?this.setRect.apply(this,arguments[0]):(this.rect=[t,e,n,i],this.width=n,this.height=i,this.regX=this.width*this.originX,this.regY=this.height*this.originY)},clone:function(){var e=new t.Bitmap(this.img);return e.rect=this.rect.slice(0),this.cloneProps(e),e}}),t.CanvasRenderer=i.extend({ctor:function(t){t&&(this.stage=t,this.ctx=t.ctx,this.height=t.width,this.width=t.height)},update:function(){this.ctx.clearRect(0,0,this.height,this.width),this.render(this.ctx,this.stage)},render:function(e,n,i){if(n.isVisible()){i?n._matrix.reinitialize(i.a,i.b,i.c,i.d,i.tx,i.ty,i.alpha,i.shadow,i.compositeOperation):n._matrix.reinitialize(1,0,0,1,0,0),i=n._matrix,i.appendTransform(n.x,n.y,n.scaleX,n.scaleY,n.rotation,n.skewX,n.skewY,n.regX,n.regY,n.filpX,n.flipY);var r=e.globalAlpha,a=e.globalCompositeOperation;e.globalAlpha*=n.alpha,e.globalCompositeOperation=n.compositeOperation;var o=n.cacheCanvas||n.txtCanvas;if(o)e.setTransform(i.a,i.b,i.c,i.d,i.tx,i.ty),e.drawImage(o,0,0);else if(n instanceof t.Container||n instanceof t.Stage)for(var s=n.children.slice(0),c=0,h=s.length;h>c;c++)e.save(),this.render(e,s[c],i),e.restore();else if(n instanceof t.Bitmap||n instanceof t.Sprite){var l=n.rect;e.setTransform(i.a,i.b,i.c,i.d,i.tx,i.ty),e.drawImage(n.img,l[0],l[1],l[2],l[3],0,0,l[2],l[3])}else if(n instanceof t.Shape){e.setTransform(i.a,i.b,i.c,i.d,i.tx,i.ty);for(var c=0,u=n.cmds.length;u>c;c++){var f=n.cmds[c];n.assMethod.join("-").match(new RegExp("\\b"+f[0]+"\\b","g"))?e[f[0]]=f[1][0]:e[f[0]].apply(e,Array.prototype.slice.call(f[1]))}}e.globalAlpha=r,e.globalCompositeOperation=a}},hitRender:function(t,e,n,i,r,a){t.clearRect(0,0,2,2),n?e._matrix.reinitialize(n.a,n.b,n.c,n.d,n.tx,n.ty,n.alpha,n.shadow,n.compositeOperation):e._matrix.reinitialize(1,0,0,1,0,0),n=e._matrix,n.appendTransform(e.x,e.y,e.scaleX,e.scaleY,e.rotation,e.skewX,e.skewY,e.regX,e.regY,e.filpX,e.flipY);for(var o=e.children.slice(0),s=o.length,c=s-1;c>=0;c--){var h=o[c];n.reinitialize(1,0,0,1,0,0),n.appendTransform(e.x-i,e.y-r,e.scaleX,e.scaleY,e.rotation,e.skewX,e.skewY,e.regX,e.regY,e.filpX,e.flipY),t.save();var h=o[c];if(this._hitRender(t,o[c],n,a),t.restore(),t.getImageData(0,0,1,1).data[3]>1)return h.execEvent(a),h}},_hitRender:function(e,n,i,r){if(n.isVisible()){i?n._matrix.reinitialize(i.a,i.b,i.c,i.d,i.tx,i.ty,i.alpha,i.shadow,i.compositeOperation):n._matrix.reinitialize(1,0,0,1,0,0),i=n._matrix,i.appendTransform(n.x,n.y,n.scaleX,n.scaleY,n.rotation,n.skewX,n.skewY,n.regX,n.regY,n.filpX,n.flipY);var a=e.globalAlpha;if(e.globalAlpha*=n.alpha,n.cacheCanvas)e.setTransform(i.a,i.b,i.c,i.d,i.tx,i.ty),e.drawImage(n.cacheCanvas||n.img,0,0);else if(n instanceof t.Container)for(var o=n.children.slice(0),s=o.length,c=s-1;c>=0;c--){var h=o[c];e.save();var h=o[c];this._hitRender(e,o[c],i),e.restore(),e.getImageData(0,0,1,1).data[3]>1&&h.execEvent(r)}else if(n instanceof t.Bitmap||n instanceof t.Sprite){var l=n.rect;e.setTransform(i.a,i.b,i.c,i.d,i.tx,i.ty),e.drawImage(n.img,l[0],l[1],l[2],l[3],0,0,l[2],l[3])}e.globalAlpha=a}},updateCache:function(t,e,n,i){t.clearRect(0,0,n+1,i+1),this.renderCache(t,e)},renderCache:function(e,n){if(n.isVisible())if(n instanceof t.Container||n instanceof t.Stage)for(var i=n.children.slice(0),r=0,a=i.length;a>r;r++)e.save(),this.render(e,i[r]),e.restore();else if(n instanceof t.Bitmap||n instanceof t.Sprite){var o=n.rect;e.drawImage(n.img,o[0],o[1],o[2],o[3],0,0,o[2],o[3])}else if(n instanceof t.Shape)for(var r=0,s=n.cmds.length;s>r;r++){var c=n.cmds[r];n.assMethod.join("-").match(new RegExp("\\b"+c[0]+"\\b","g"))?e[c[0]]=c[1][0]:e[c[0]].apply(e,Array.prototype.slice.call(c[1]))}}}),t.WebGLRenderer=i.extend({ctor:function(e){this.root=e,this.surface=e.canvas,this.MAX_DEPTH=1048576,this.snapToPixel=!0,this.canvasRenderer=new t.CanvasRenderer},getSurface:function(t,e){return null==this.surface&&(this.surface=document.createElement("canvas")),t&&(this.surface.width=t),e&&(this.surface.height=e),this.surface},clear:function(){this.surface&&(this.surface.init||this.initSurface(this.surface))},initSurface:function(e){var n=void 0;try{n=e.ctx=e.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),n.viewportWidth=e.width,n.viewportHeight=e.height}catch(i){}n||alert("Could not initialise WebGL. Make sure you've updated your browser, or try a different one like Google Chrome."),e.idMatrix=t.GLMatrix.mat4.create(),e.orthMatrix=t.GLMatrix.mat4.create(),this._matPool=[];var r=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(r,"precision highp float;\nvarying vec3 vTextureCoord;\nvarying float vAlpha;\nuniform float uAlpha;\nuniform sampler2D uSampler0,uSampler1,uSampler2,uSampler3,uSampler4,uSampler5,uSampler6,uSampler7,uSampler8,uSampler9,uSampler10,uSampler11,uSampler12,uSampler13,uSampler14,uSampler15;\nvoid main(void) { \nint sampler = int(vTextureCoord.z); \nvec4 color;\nvec2 coord = vec2(vTextureCoord.s, vTextureCoord.t);\n if (sampler == 0) { color = texture2D(uSampler0, coord); } \nelse if (sampler == 1) { color = texture2D(uSampler1, coord); } \nelse if (sampler == 2) { color = texture2D(uSampler2, coord); } \nelse if (sampler == 3) { color = texture2D(uSampler3, coord); } \nelse if (sampler == 4) { color = texture2D(uSampler4, coord); } \nelse if (sampler == 5) { color = texture2D(uSampler5, coord); } \nelse if (sampler == 6) { color = texture2D(uSampler6, coord); } \nelse if (sampler == 7) { color = texture2D(uSampler7, coord); } \nelse if (sampler == 8) { color = texture2D(uSampler8, coord); } \nelse if (sampler == 9) { color = texture2D(uSampler9, coord); } \nelse if (sampler == 10) { color = texture2D(uSampler10, coord); } \nelse if (sampler == 11) { color = texture2D(uSampler11, coord); } \nelse if (sampler == 12) { color = texture2D(uSampler12, coord); } \nelse if (sampler == 13) { color = texture2D(uSampler13, coord); } \nelse if (sampler == 14) { color = texture2D(uSampler14, coord); } \nelse if (sampler == 15) { color = texture2D(uSampler15, coord); } \nelse { color = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t)); } \ngl_FragColor = vec4(color.rgb, color.a * vAlpha);\n}"),n.compileShader(r),n.getShaderParameter(r,n.COMPILE_STATUS)||alert(n.getShaderInfoLog(r));var a=n.createShader(n.VERTEX_SHADER);n.shaderSource(a,"attribute vec3 aVertexPosition;\nattribute vec3 aTextureCoord;\nattribute float aAlpha;\nuniform mat4 uPMatrix;\nuniform bool uSnapToPixel;\nvarying vec3 vTextureCoord;\nvarying float vAlpha;\nvoid main(void) { \nvTextureCoord = aTextureCoord; \nvAlpha = aAlpha; \ngl_Position = uPMatrix * vec4(aVertexPosition, 1.0);\n}"),n.compileShader(a),n.getShaderParameter(a,n.COMPILE_STATUS)||alert(n.getShaderInfoLog(a));var o=e.shader=n.createProgram();n.attachShader(o,a),n.attachShader(o,r),n.linkProgram(o),n.getProgramParameter(o,n.LINK_STATUS)||alert("Could not initialise shaders"),n.enableVertexAttribArray(o.vertexPositionAttribute=n.getAttribLocation(o,"aVertexPosition")),n.enableVertexAttribArray(o.uvCoordAttribute=n.getAttribLocation(o,"aTextureCoord")),n.enableVertexAttribArray(o.colorAttribute=n.getAttribLocation(o,"aAlpha")),o.orthMatrixUniform=n.getUniformLocation(o,"uPMatrix"),o.alphaUniform=n.getUniformLocation(o,"uAlpha"),o.snapToUniform=n.getUniformLocation(o,"uSnapToPixel"),n.useProgram(o),this._vertexDataCount=7,this._root2=Math.sqrt(2),this._index=0,this._textures=[],this._cacheTextures=[],this._degToRad=Math.PI/180,this.vertices=window.Float32Array?new window.Float32Array(4*this._vertexDataCount*5e3):new Array(4*this._vertexDataCount*5e3),this.arrayBuffer=n.createBuffer(),this.indexBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.arrayBuffer),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var s=4*this._vertexDataCount;n.vertexAttribPointer(o.vertexPositionAttribute,3,n.FLOAT,0,s,0),n.vertexAttribPointer(o.uvCoordAttribute,3,n.FLOAT,0,s,12),n.vertexAttribPointer(o.colorAttribute,1,n.FLOAT,0,s,24),this.indices=window.Uint16Array?new window.Uint16Array(3e4):new Array(3e4);for(var c=0,h=this.indices.length;h>c;c+=6){var l=4*c/6;this.indices.set([l,l+1,l+2,l,l+2,l+3],c)}n.bufferData(n.ARRAY_BUFFER,this.vertices,n.STREAM_DRAW),n.bufferData(n.ELEMENT_ARRAY_BUFFER,this.indices,n.STATIC_DRAW),t.GLMatrix.mat4.ortho(0,n.viewportWidth,n.viewportHeight,0,-this.MAX_DEPTH,this.MAX_DEPTH,e.orthMatrix),n.viewport(0,0,n.viewportWidth,n.viewportHeight),n.colorMask(!0,!0,!0,!0),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.SRC_ALPHA,n.ONE),n.enable(n.BLEND),n.disable(n.DEPTH_TEST),e.init=!0},_initTexture:function(t,e){if(t){for(var n=this._textures,i=this._cacheTextures.length+this._textures.length,r=0,a=n.length;a>r;r++)if(n[r].image==t)return t.glTexture=n[r],r;return t.glTexture?(e.activeTexture(e["TEXTURE"+i]),e.bindTexture(e.TEXTURE_2D,t.glTexture)):(t.glTexture=e.createTexture(),t.glTexture.image=t,e.activeTexture(e["TEXTURE"+i]),e.bindTexture(e.TEXTURE_2D,t.glTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.glTexture.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.uniform1i(e.getUniformLocation(e.canvas.shader,"uSampler"+i.toString()),i),n.push(t.glTexture),i}},_initCache:function(t,e,n){if(e){for(var i=this._cacheTextures,r=this._cacheTextures.length+this._textures.length,a=0,o=i.length;o>a;a++)if(t.cacheID&&i[a]._cacheID==t.cacheID)return i[a]._isUsed=!0,e.glTexture=i[a],n.activeTexture(n["TEXTURE"+r]),n.bindTexture(n.TEXTURE_2D,e.glTexture),this._textures.push(e.glTexture),a;return e.glTexture?(n.activeTexture(n["TEXTURE"+r]),n.bindTexture(n.TEXTURE_2D,e.glTexture)):(e.glTexture=n.createTexture(),e.glTexture.image=e,n.activeTexture(n["TEXTURE"+r]),n.bindTexture(n.TEXTURE_2D,e.glTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e.glTexture.image),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)),n.uniform1i(n.getUniformLocation(n.canvas.shader,"uSampler"+r.toString()),r),e._cacheID=t.cacheID,e.glTexture._isUsed=!0,this._textures.push(e.glTexture),i.push(e.glTexture),r}},render:function(e,n){e=e||this.root,n=n||this.surface;var i=n.ctx;if(this.snapToPixel?i.uniform1i(n.shader.snapToUniform,1):i.uniform1i(n.shader.snapToUniform,0),t.GLMatrix.mat4.identity(n.idMatrix),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.uniformMatrix4fv(n.shader.orthMatrixUniform,!1,n.orthMatrix),n.init||this.initSurface(n),e&&n){var r=document.createDocumentFragment();this._render(i,e,n.idMatrix,r),this._draw(i)}this._cleanCache()},_getCompositeOperation:function(t){return t.compositeOperation?t.compositeOperation:t.parent?this._getCompositeOperation(t.parent):void 0},_render:function(e,n,i){var a=t.GLMatrix.mat4;if(n.isVisible()){var o=(this._index+4)*this._vertexDataCount;this.vertices.length<o&&this._draw(e);var s=0,c=0,h=1,l=1,u=0,f=this._degToRad,d=this._getMat4(),m=0,p=this._getCompositeOperation(n);"lighter"===p?e.blendFunc(e.SRC_ALPHA,e.ONE):e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);var g=n.cacheCanvas||n.txtCanvas;if(g)m=this._initCache(n,g,e),a.translate(i,[n.x,n.y,0],d),a.rotateX(d,n.skewX*f),a.rotateY(d,n.skewY*f),a.rotateZ(d,n.rotation*f),a.scale(d,[n.scaleX*g.width,n.scaleY*g.height,1]),a.translate(d,[-n.originX,-n.originY,0]);else{if(n instanceof t.Container){var v=n.children.slice(0);a.translate(i,[n.x,n.y,0],d),a.rotateX(d,n.skewX*f),a.rotateY(d,n.skewY*f),a.rotateZ(d,n.rotation*f),a.scale(d,[n.scaleX,n.scaleY,1]),a.translate(d,[-n.originX,-n.originY,0]);for(var w=0,y=v.length;y>w;w++)this._render(e,v[w],d);return void this._poolMat4(d)}if(n instanceof t.Bitmap||n instanceof t.Sprite){var x=n.rect;u=n.img,m=this._initTexture(u,e),h=x[2]/u.width,l=x[3]/u.height,s=x[0]/u.width,c=x[1]/u.height,a.translate(i,[n.x,n.y,0],d),a.rotateX(d,n.skewX*f),a.rotateY(d,n.skewY*f),a.rotateZ(d,n.rotation*f),a.scale(d,[n.scaleX*x[2],n.scaleY*x[3],1]),a.translate(d,[-n.originX,-n.originY,0])}}var b=a.multiplyVec3(d,[0,0,0]),_=a.multiplyVec3(d,[0,1,0]),T=a.multiplyVec3(d,[1,1,0]),k=a.multiplyVec3(d,[1,0,0]),C=n.alpha;this.vertices.set([b[0],b[1],b[2],s,c,m,C,_[0],_[1],_[2],s,c+l,m,C,T[0],T[1],T[2],s+h,c+l,m,C,k[0],k[1],k[2],s+h,c,m,C],this._index*this._vertexDataCount),this._index+=4,this._poolMat4(d),this._textures.length+this._cacheTextures.length>31&&this._draw(e)}},_draw:function(t){t.bufferSubData(t.ARRAY_BUFFER,0,this.vertices.subarray(0,this._index*this._vertexDataCount)),t.drawElements(t.TRIANGLES,1.5*this._index,t.UNSIGNED_SHORT,0),this._index=0,this._textureCount=0,this._textures=[]},_cleanCache:function(){for(var t=this._cacheTextures,e=0,n=t.length;n>e;e++)t[e]._isUsed?t[e]._isUsed=!1:(t.splice(e,1),e--,n--)},_getMat4:function(){return this._matPool.length>0?this._matPool.pop():t.GLMatrix.mat4.create()},_poolMat4:function(t){this._matPool.push(t)},update:function(){this.clear(),this.tickOnUpdate&&this.tickDisplayList(this.root,this.arguments),this.render(this.root,this.surface)},updateCache:function(t,e,n,i){t.clearRect(0,0,n+1,i+1),this.renderCache(t,e)},renderCache:function(e,n){if(n.isVisible())if(n instanceof t.Container||n instanceof t.Stage)for(var i=n.children.slice(0),r=0,a=i.length;a>r;r++)e.save(),this.canvasRenderer.render(e,i[r]),e.restore();else if(n instanceof t.Bitmap||n instanceof t.Sprite){var o=n.rect;e.drawImage(n.img,o[0],o[1],o[2],o[3],0,0,o[2],o[3])}else if(n instanceof t.Shape)for(var r=0,s=n.cmds.length;s>r;r++){var c=n.cmds[r];n.assMethod.join("-").match(new RegExp("\\b"+c[0]+"\\b","g"))?e[c[0]]=c[1][0]:e[c[0]].apply(e,Array.prototype.slice.call(c[1]))}}}),t.RAF=i.extend({statics:{ctor:function(){var t=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),e=function(e,n){function a(){var o=(new Date).getTime(),s=o-i;s>=n&&(e.call(),i=(new Date).getTime()),r.value=t(a)}if(!(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame&&window.mozCancelRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame))return window.setInterval(e,n);var i=(new Date).getTime(),r=new Object;return r.value=t(a),r},n=function(t){t&&setTimeout(function(){window.cancelAnimationFrame?window.cancelAnimationFrame(t.value):window.webkitCancelAnimationFrame?window.webkitCancelAnimationFrame(t.value):window.webkitCancelRequestAnimationFrame?window.webkitCancelRequestAnimationFrame(t.value):window.mozCancelRequestAnimationFrame?window.mozCancelRequestAnimationFrame(t.value):window.oCancelRequestAnimationFrame?window.oCancelRequestAnimationFrame(t.value):window.msCancelRequestAnimationFrame?window.msCancelRequestAnimationFrame(t.value):clearInterval(t)},0)};this.requestInterval=e,this.clearRequestInterval=n}}}),t.Loader=i.extend({ctor:function(){this.audios={},this.res={},this.loadedCount=0,this.resCount=-1,this.FILE_PATTERN=/(\w+:\/{2})?((?:\w+\.){2}\w+)?(\/?[\S]+\/|\/)?([\w\-%\.]+)(?:\.)(\w+)?(\?\S+)?/i,this.ns=3,this.sounds=[];for(var t=0;t<this.ns;t++)this.sounds.push([]);this.playing=[],this.soundsCount=0},get:function(t){return this.res[t]},loadRes:function(t){this.resCount=t.length;for(var e=0;e<t.length;e++)"audio"==this._getTypeByExtension(t[e].src.match(this.FILE_PATTERN)[5])?this.loadAudio(t[e].id,t[e].src):this.loadImage(t[e].id,t[e].src)},loadImage:function(t,e){var n=document.createElement("img"),i=this;n.onload=function(){i._handleLoad(this,t),n.onreadystatechange=null},n.onreadystatechange=function(){("loaded"==n.readyState||"complete"==n.readyState)&&(i._handleLoad(this,t),n.onload=null)},n.onerror=function(){},n.src=e},loadAudio:function(t,e){var n=document.createElement("audio");n.autoplay=!1,this.res[t]=n,n.src=null,n.preload="auto",n.onerror=function(){},n.onstalled=function(){};var i=this,r=function(){i.playing[t]=0;for(var n=0;n<i.ns;n++)i.sounds[n][t]=new Audio(e);i.loadedCount++,i.handleProgress(i.loadedCount,i.resCount),i._clean(this),this.removeEventListener&&this.removeEventListener("canplaythrough",r,!1),i.checkComplete()};n.addEventListener("canplaythrough",r,!1),n.src=e,null!=n.load&&n.load()},checkComplete:function(){this.loadedCount===this.resCount&&this.handleComplete()},complete:function(t){this.handleComplete=t},progress:function(t){this.handleProgress=t},playSound:function(t){this.sounds[this.playing[t]][t].play(),++this.playing[t],this.playing[t]>=this.ns&&(this.playing[t]=0)},_handleLoad:function(t,e){this._clean(t),this.res[e]=t,this.loadedCount++,this.handleProgress&&this.handleProgress(this.loadedCount,this.resCount),this.checkComplete()},_getTypeByExtension:function(t){switch(t){case"jpeg":case"jpg":case"gif":case"png":case"webp":case"bmp":return"img";case"ogg":case"mp3":case"wav":return"audio"}},_clean:function(t){t.onload=null,t.onstalled=null,t.onprogress=null,t.onerror=null}}),t.Keyboard=i.extend({statics:{ctor:function(){function u(){window.addEventListener?(window.document.addEventListener("keydown",m,!1),window.document.addEventListener("keyup",p,!1),window.addEventListener("blur",d,!1),window.addEventListener("webkitfullscreenchange",d,!1),window.addEventListener("mozfullscreenchange",d,!1)):window.attachEvent&&(window.document.attachEvent("onkeydown",m),window.document.attachEvent("onkeyup",p),window.attachEvent("onblur",d))}function f(){d(),window.removeEventListener?(window.document.removeEventListener("keydown",m,!1),window.document.removeEventListener("keyup",p,!1),window.removeEventListener("blur",d,!1),window.removeEventListener("webkitfullscreenchange",d,!1),window.removeEventListener("mozfullscreenchange",d,!1)):window.detachEvent&&(window.document.detachEvent("onkeydown",m),window.document.detachEvent("onkeyup",p),window.detachEvent("onblur",d))}function d(t){a=[],b(),E(t)}function m(t){var e,n,i;if(e=g(t.keyCode),!(e.length<1)){for(t.isRepeat=!1,i=0;i<e.length;i+=1)n=e[i],-1!=X().indexOf(n)&&(t.isRepeat=!0),I(n);x(),C(t)}}function p(t){var e,n;if(e=g(t.keyCode),!(e.length<1)){for(n=0;n<e.length;n+=1)L(e[n]);b(),E(t)}}function g(t){return i[t]||[]}function v(t){var e;for(e in i)if(i.hasOwnProperty(e)&&i[e].indexOf(t)>-1)return e;return!1}function w(t,e){if("string"!=typeof t&&("object"!=typeof t||"function"!=typeof t.push))throw new Error("Cannot create macro. The combo must be a string or array.");if("object"!=typeof e||"function"!=typeof e.push)throw new Error("Cannot create macro. The injectedKeys must be an array.");r.push([t,e])}function y(t){var e,n;if("string"!=typeof t&&("object"!=typeof t||"function"!=typeof t.push))throw new Error("Cannot remove macro. The combo must be a string or array.");for(n=0;n<r.length;n+=1)if(e=r[n],A(t,e[0])){L(e[1]),r.splice(n,1);break}}function x(){var t,e,n;for(t=0;t<r.length;t+=1)if(e=D(r[t][0]),-1===c.indexOf(r[t])&&R(e))for(c.push(r[t]),n=0;n<r[t][1].length;n+=1)I(r[t][1][n])}function b(){var t,e,n;for(t=0;t<c.length;t+=1)if(e=D(c[t][0]),R(e)===!1){for(n=0;n<c[t][1].length;n+=1)L(c[t][1][n]);c.splice(t,1),t-=1}}function _(t,e,n){function l(){var t;for(t=0;t<a.length;t+=1)o.splice(o.indexOf(a[t]),1)}function u(t){function o(){var e,i;for(e=0;e<n.length;e+=1)if("function"==typeof n[e])if("keyup"===t)for(i=0;i<a.length;i+=1)a[i].keyUpCallback.splice(a[i].keyUpCallback.indexOf(n[e]),1);else for(i=0;i<a.length;i+=1)a[i].keyDownCallback.splice(a[i].keyDownCallback.indexOf(n[e]),1)}var n,i,r,e={};if("string"!=typeof t)throw new Error("Cannot bind callback. The event name must be a string.");if("keyup"!==t&&"keydown"!==t)throw new Error('Cannot bind callback. The event name must be a "keyup" or "keydown".');for(n=Array.prototype.slice.apply(arguments,[1]),i=0;i<n.length;i+=1)if("function"==typeof n[i])if("keyup"===t)for(r=0;r<a.length;r+=1)a[r].keyUpCallback.push(n[i]);else if("keydown"===t)for(r=0;r<a.length;r+=1)a[r].keyDownCallback.push(n[i]);return e.clear=o,e}var r,c,h,i={},a=[];for("string"==typeof t&&(t=D(t)),c=0;c<t.length;c+=1){if(r={},h=M([t[c]]),"string"!=typeof h)throw new Error("Failed to bind key combo. The key combo must be string.");r.keyCombo=h,r.keyDownCallback=[],r.keyUpCallback=[],e&&r.keyDownCallback.push(e),n&&r.keyUpCallback.push(n),o.push(r),a.push(r)}return i.clear=l,i.on=u,i}function T(t){var e,n;for(e=0;e<o.length;e+=1)n=o[e],A(t,n.keyCombo)&&(o.splice(e,1),e-=1)}function k(t){var e,n,i;if(t){for(e=0;e<o.length;e+=1)for(i=o[e],n=0;n<i.keyCombo.length;n+=1)if(i.keyCombo[n].indexOf(t)>-1){o.splice(e,1),e-=1;break}}else o=[]}function C(t){var e,n,i,r,c,h,l,u,f,d,p,m=[];for(c=[].concat(a),e=0;e<o.length;e+=1)p=S(o[e].keyCombo).length,m[p]||(m[p]=[]),m[p].push(o[e]);for(n=m.length-1;n>=0;n-=1)if(m[n])for(e=0;e<m[n].length;e+=1){for(i=m[n][e],r=S(i.keyCombo),f=!0,u=0;u<r.length;u+=1)if(-1===c.indexOf(r[u])){f=!1;
break}if(f&&R(i.keyCombo)){for(s.push(i),u=0;u<r.length;u+=1)d=c.indexOf(r[u]),d>-1&&(c.splice(d,1),u-=1);for(h=0;h<i.keyDownCallback.length;h+=1)i.keyDownCallback[h](t,X(),i.keyCombo)===!1&&(l=!0);l===!0&&(t.preventDefault(),t.stopPropagation())}}}function E(t){var e,n,i,r;for(e=0;e<s.length;e+=1)if(i=s[e],R(i.keyCombo)===!1){for(n=0;n<i.keyUpCallback.length;n+=1)i.keyUpCallback[n](t,X(),i.keyCombo)===!1&&(r=!0);r===!0&&(t.preventDefault(),t.stopPropagation()),s.splice(e,1),e-=1}}function A(t,e){var n,i,r;if(t=D(t),e=D(e),t.length!==e.length)return!1;for(n=0;n<t.length;n+=1){if(t[n].length!==e[n].length)return!1;for(i=0;i<t[n].length;i+=1){if(t[n][i].length!==e[n][i].length)return!1;for(r=0;r<t[n][i].length;r+=1)if(-1===e[n][i].indexOf(t[n][i][r]))return!1}}return!0}function R(t){var e,n,i,r,s,c,o=0;for(t=D(t),e=0;e<t.length;e+=1){for(c=!0,o=0,n=0;n<t[e].length;n+=1){for(i=[].concat(t[e][n]),r=o;r<a.length;r+=1)s=i.indexOf(a[r]),s>-1&&(i.splice(s,1),o=r);if(0!==i.length){c=!1;break}}if(c)return!0}return!1}function S(t){var e,n,r=[];for(t=D(t),e=0;e<t.length;e+=1)for(n=0;n<t[e].length;n+=1)r=r.concat(t[e][n]);return r}function D(t){var e=t,n=0,i=0,r=!1,a=!1,o=[],s=[],c=[],h="";if("object"==typeof t&&"function"==typeof t.push)return t;if("string"!=typeof t)throw new Error('Cannot parse "keyCombo" because its type is "'+typeof t+'". It must be a "string".');for(;" "===e.charAt(n);)n+=1;for(;;){if(" "===e.charAt(n)){for(;" "===e.charAt(n);)n+=1;r=!0}else if(","===e.charAt(n)){if(i||a)throw new Error("Failed to parse key combo. Unexpected , at character index "+n+".");a=!0,n+=1}else if("+"===e.charAt(n)){if(h.length&&(c.push(h),h=""),i||a)throw new Error("Failed to parse key combo. Unexpected + at character index "+n+".");i=!0,n+=1}else if(">"===e.charAt(n)){if(h.length&&(c.push(h),h=""),c.length&&(s.push(c),c=[]),i||a)throw new Error("Failed to parse key combo. Unexpected > at character index "+n+".");i=!0,n+=1}else if(n<e.length-1&&"!"===e.charAt(n)&&(">"===e.charAt(n+1)||","===e.charAt(n+1)||"+"===e.charAt(n+1)))h+=e.charAt(n+1),i=!1,r=!1,a=!1,n+=2;else{if(!(n<e.length&&"+"!==e.charAt(n)&&">"!==e.charAt(n)&&","!==e.charAt(n)&&" "!==e.charAt(n))){n+=1;continue}for((i===!1&&r===!0||a===!0)&&(h.length&&(c.push(h),h=""),c.length&&(s.push(c),c=[]),s.length&&(o.push(s),s=[])),i=!1,r=!1,a=!1;n<e.length&&"+"!==e.charAt(n)&&">"!==e.charAt(n)&&","!==e.charAt(n)&&" "!==e.charAt(n);)h+=e.charAt(n),n+=1}if(n>=e.length){h.length&&(c.push(h),h=""),c.length&&(s.push(c),c=[]),s.length&&(o.push(s),s=[]);break}}return o}function M(t){var e,n,i=[];if("string"==typeof t)return t;if("object"!=typeof t||"function"!=typeof t.push)throw new Error("Cannot stringify key combo.");for(e=0;e<t.length;e+=1){for(i[e]=[],n=0;n<t[e].length;n+=1)i[e][n]=t[e][n].join(" + ");i[e]=i[e].join(" > ")}return i.join(" ")}function X(){return[].concat(a)}function I(t){if(t.match(/\s/))throw new Error("Cannot add key name "+t+" to active keys because it contains whitespace.");a.indexOf(t)>-1||a.push(t)}function L(t){var e=v(t);"91"===e||"92"===e?a=[]:a.splice(a.indexOf(t),1)}function P(t,n){if("string"!=typeof t)throw new Error("Cannot register new locale. The locale name must be a string.");if("object"!=typeof n)throw new Error("Cannot register "+t+" locale. The locale map must be an object.");if("object"!=typeof n.map)throw new Error("Cannot register "+t+" locale. The locale map is invalid.");n.macros||(n.macros=[]),e[t]=n}function F(t){if(t){if("string"!=typeof t)throw new Error("Cannot set locale. The locale name must be a string.");if(!e[t])throw new Error("Cannot set locale to "+t+" because it does not exist. If you would like to submit a "+t+" locale map for KeyboardJS please submit it at https://github.com/RobertWHurst/KeyboardJS/issues.");i=e[t].map,r=e[t].macros,n=t}return n}var n,i,r,h,l,t={},e={},a=[],o=[],s=[],c=[];for(l={map:{3:["cancel"],8:["backspace"],9:["tab"],12:["clear"],13:["enter"],16:["shift"],17:["ctrl"],18:["alt","menu"],19:["pause","break"],20:["capslock"],27:["escape","esc"],32:["space","spacebar"],33:["pageup"],34:["pagedown"],35:["end"],36:["home"],37:["left"],38:["up"],39:["right"],40:["down"],41:["select"],42:["printscreen"],43:["execute"],44:["snapshot"],45:["insert","ins"],46:["delete","del"],47:["help"],91:["command","windows","win","super","leftcommand","leftwindows","leftwin","leftsuper"],92:["command","windows","win","super","rightcommand","rightwindows","rightwin","rightsuper"],145:["scrolllock","scroll"],186:["semicolon",";"],187:["equal","equalsign","="],188:["comma",","],189:["dash","-"],190:["period","."],191:["slash","forwardslash","/"],192:["graveaccent","`"],219:["openbracket","["],220:["backslash","\\"],221:["closebracket","]"],222:["apostrophe","'"],48:["zero","0"],49:["one","1"],50:["two","2"],51:["three","3"],52:["four","4"],53:["five","5"],54:["six","6"],55:["seven","7"],56:["eight","8"],57:["nine","9"],96:["numzero","num0"],97:["numone","num1"],98:["numtwo","num2"],99:["numthree","num3"],100:["numfour","num4"],101:["numfive","num5"],102:["numsix","num6"],103:["numseven","num7"],104:["numeight","num8"],105:["numnine","num9"],106:["nummultiply","num*"],107:["numadd","num+"],108:["numenter"],109:["numsubtract","num-"],110:["numdecimal","num."],111:["numdivide","num/"],144:["numlock","num"],112:["f1"],113:["f2"],114:["f3"],115:["f4"],116:["f5"],117:["f6"],118:["f7"],119:["f8"],120:["f9"],121:["f10"],122:["f11"],123:["f12"]},macros:[["shift + `",["tilde","~"]],["shift + 1",["exclamation","exclamationpoint","!"]],["shift + 2",["at","@"]],["shift + 3",["number","#"]],["shift + 4",["dollar","dollars","dollarsign","$"]],["shift + 5",["percent","%"]],["shift + 6",["caret","^"]],["shift + 7",["ampersand","and","&"]],["shift + 8",["asterisk","*"]],["shift + 9",["openparen","("]],["shift + 0",["closeparen",")"]],["shift + -",["underscore","_"]],["shift + =",["plus","+"]],["shift + (",["opencurlybrace","opencurlybracket","{"]],["shift + )",["closecurlybrace","closecurlybracket","}"]],["shift + \\",["verticalbar","|"]],["shift + ;",["colon",":"]],["shift + '",["quotationmark",'"']],["shift + !,",["openanglebracket","<"]],["shift + .",["closeanglebracket",">"]],["shift + /",["questionmark","?"]]]},h=65;90>=h;h+=1)l.map[h]=String.fromCharCode(h+32),l.macros.push(["shift + "+String.fromCharCode(h+32)+", capslock + "+String.fromCharCode(h+32),[String.fromCharCode(h)]]);P("us",l),F("us"),u(),t.enable=u,t.disable=f,t.activeKeys=X,t.releaseKey=L,t.pressKey=I,t.on=_,t.clear=T,t.clear.key=k,t.locale=F,t.locale.register=P,t.macro=w,t.macro.remove=y,t.key={},t.key.name=g,t.key.code=v,t.combo={},t.combo.active=R,t.combo.parse=D,t.combo.stringify=M,this.Keyboard=t},on:function(t,e,n){this.Keyboard.on(t,e,n)},getActiveKeys:function(){return this.Keyboard.activeKeys()}}}),t.Shape=t.DisplayObject.extend({ctor:function(){this._super(),this.cmds=[],this.assMethod=["fillStyle","strokeStyle","lineWidth"]},setBound:function(t,e){this.width=t,this.height=e},draw:function(t){for(var e=0,n=this.cmds.length;n>e;e++){var i=this.cmds[e];this.assMethod.join("-").match(new RegExp("\\b"+i[0]+"\\b","g"))?t[i[0]]=i[1][0]:t[i[0]].apply(t,Array.prototype.slice.call(i[1]))}},strokeRect:function(){return this.cmds.push(["strokeRect",arguments]),this},fillRect:function(){return this.cmds.push(["fillRect",arguments]),this},beginPath:function(){return this.cmds.push(["beginPath",arguments]),this},arc:function(){return this.cmds.push(["arc",arguments]),this},closePath:function(){return this.cmds.push(["closePath",arguments]),this},fillStyle:function(){return this.cmds.push(["fillStyle",arguments]),this},fill:function(){return this.cmds.push(["fill",arguments]),this},strokeStyle:function(){return this.cmds.push(["strokeStyle",arguments]),this},lineWidth:function(){return this.cmds.push(["lineWidth",arguments]),this},stroke:function(){return this.cmds.push(["stroke",arguments]),this},moveTo:function(){return this.cmds.push(["moveTo",arguments]),this},lineTo:function(){return this.cmds.push(["lineTo",arguments]),this},bezierCurveTo:function(){return this.cmds.push(["bezierCurveTo",arguments]),this},clone:function(){}}),t.Sprite=t.DisplayObject.extend({ctor:function(t){this._super(),this.option=t,this.x=t.x||0,this.y=t.y||0,this.currentFrameIndex=0,this.animationFrameIndex=0,this.currentAnimation=t.currentAnimation||null,this.rect=[0,0,10,10],this.img=this.option.imgs[0],this.interval=1e3/t.framerate,this.loop=null,this.paused=!1,this.animationEnd=t.animationEnd||null,this.currentAnimation&&this.gotoAndPlay(this.currentAnimation),this.tickAnimationEnd=t.tickAnimationEnd||null},play:function(){this.paused=!1},stop:function(){this.paused=!0},reset:function(){this.currentFrameIndex=0,this.animationFrameIndex=0},gotoAndPlay:function(e,n){this.paused=!1,this.reset(),t.RAF.clearRequestInterval(this.loop),this.currentAnimation=e;var i=this,r=0;this.loop=t.RAF.requestInterval(function(){if(!i.paused){var e=i.option,a=e.animations[i.currentAnimation].frames,o=a.length;i.animationFrameIndex++,i.animationFrameIndex>o-1&&(r++,i.animationFrameIndex=0,i.tickAnimationEnd&&i.tickAnimationEnd(),n&&r==n&&(i.animationEnd&&i.animationEnd(),i.paused=!0,t.RAF.clearRequestInterval(i.loop),i.parent.remove(i))),i.rect=e.frames[a[i.animationFrameIndex]],i.rect.length>4&&(i.img=e.imgs[i.rect[4]])}},this.interval)},gotoAndStop:function(e){this.reset(),t.RAF.clearRequestInterval(this.loop);var n=this;n.currentAnimation=e;{var i=n.option,r=i.animations[n.currentAnimation].frames;r.length}n.rect=i.frames[r[n.animationFrameIndex]],n.rect.length>4&&(n.img=i.imgs[n.rect[4]])}}),t.GLMatrix=i.extend({statics:{ctor:function(){var t="undefined"!=typeof window.Float32Array?window.Float32Array:"undefined"!=typeof window.WebGLFloatArray?window.WebGLFloatArray:Array,e={};e.create=function(e){var n=new t(3);return e&&(n[0]=e[0],n[1]=e[1],n[2]=e[2]),n},e.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},e.add=function(t,e,n){return n&&t!=n?(n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},e.subtract=function(t,e,n){return n&&t!=n?(n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},e.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},e.scale=function(t,e,n){return n&&t!=n?(n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n):(t[0]*=e,t[1]*=e,t[2]*=e,t)},e.normalize=function(t,e){e||(e=t);var n=t[0],i=t[1],r=t[2],a=Math.sqrt(n*n+i*i+r*r);return a?1==a?(e[0]=n,e[1]=i,e[2]=r,e):(a=1/a,e[0]=n*a,e[1]=i*a,e[2]=r*a,e):(e[0]=0,e[1]=0,e[2]=0,e)},e.cross=function(t,e,n){n||(n=t);var i=t[0],r=t[1];t=t[2];var a=e[0],o=e[1];return e=e[2],n[0]=r*e-t*o,n[1]=t*a-i*e,n[2]=i*o-r*a,n},e.length=function(t){var e=t[0],n=t[1];return t=t[2],Math.sqrt(e*e+n*n+t*t)},e.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},e.direction=function(t,e,n){n||(n=t);var i=t[0]-e[0],r=t[1]-e[1];return t=t[2]-e[2],(e=Math.sqrt(i*i+r*r+t*t))?(e=1/e,n[0]=i*e,n[1]=r*e,n[2]=t*e,n):(n[0]=0,n[1]=0,n[2]=0,n)},e.lerp=function(t,e,n,i){return i||(i=t),i[0]=t[0]+n*(e[0]-t[0]),i[1]=t[1]+n*(e[1]-t[1]),i[2]=t[2]+n*(e[2]-t[2]),i},e.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"};var n={};n.create=function(e){var n=new t(9);return e&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9]),n},n.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},n.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},n.transpose=function(t,e){if(!e||t==e){var n=t[1],i=t[2],r=t[5];return t[1]=t[3],t[2]=t[6],t[3]=n,t[5]=t[7],t[6]=i,t[7]=r,t}return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},n.toMat4=function(t,e){return e||(e=i.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},n.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"};var i={};i.create=function(e){var n=new t(16);return e&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n},i.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},i.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.transpose=function(t,e){if(!e||t==e){var n=t[1],i=t[2],r=t[3],a=t[6],o=t[7],s=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=n,t[6]=t[9],t[7]=t[13],t[8]=i,t[9]=a,t[11]=t[14],t[12]=r,t[13]=o,t[14]=s,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},i.determinant=function(t){var e=t[0],n=t[1],i=t[2],r=t[3],a=t[4],o=t[5],s=t[6],c=t[7],h=t[8],l=t[9],u=t[10],f=t[11],d=t[12],m=t[13],p=t[14];return t=t[15],d*l*s*r-h*m*s*r-d*o*u*r+a*m*u*r+h*o*p*r-a*l*p*r-d*l*i*c+h*m*i*c+d*n*u*c-e*m*u*c-h*n*p*c+e*l*p*c+d*o*i*f-a*m*i*f-d*n*s*f+e*m*s*f+a*n*p*f-e*o*p*f-h*o*i*t+a*l*i*t+h*n*s*t-e*l*s*t-a*n*u*t+e*o*u*t},i.inverse=function(t,e){e||(e=t);var n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],s=t[5],c=t[6],h=t[7],l=t[8],u=t[9],f=t[10],d=t[11],m=t[12],p=t[13],g=t[14],v=t[15],w=n*s-i*o,y=n*c-r*o,x=n*h-a*o,b=i*c-r*s,_=i*h-a*s,T=r*h-a*c,k=l*p-u*m,C=l*g-f*m,E=l*v-d*m,A=u*g-f*p,R=u*v-d*p,S=f*v-d*g,D=1/(w*S-y*R+x*A+b*E-_*C+T*k);return e[0]=(s*S-c*R+h*A)*D,e[1]=(-i*S+r*R-a*A)*D,e[2]=(p*T-g*_+v*b)*D,e[3]=(-u*T+f*_-d*b)*D,e[4]=(-o*S+c*E-h*C)*D,e[5]=(n*S-r*E+a*C)*D,e[6]=(-m*T+g*x-v*y)*D,e[7]=(l*T-f*x+d*y)*D,e[8]=(o*R-s*E+h*k)*D,e[9]=(-n*R+i*E-a*k)*D,e[10]=(m*_-p*x+v*w)*D,e[11]=(-l*_+u*x-d*w)*D,e[12]=(-o*A+s*C-c*k)*D,e[13]=(n*A-i*C+r*k)*D,e[14]=(-m*b+p*y-g*w)*D,e[15]=(l*b-u*y+f*w)*D,e},i.toRotationMat=function(t,e){return e||(e=i.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i.toMat3=function(t,e){return e||(e=n.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},i.toInverseMat3=function(t,e){var i=t[0],r=t[1],a=t[2],o=t[4],s=t[5],c=t[6],h=t[8],l=t[9],u=t[10],f=u*s-c*l,d=-u*o+c*h,m=l*o-s*h,p=i*f+r*d+a*m;return p?(p=1/p,e||(e=n.create()),e[0]=f*p,e[1]=(-u*r+a*l)*p,e[2]=(c*r-a*s)*p,e[3]=d*p,e[4]=(u*i-a*h)*p,e[5]=(-c*i+a*o)*p,e[6]=m*p,e[7]=(-l*i+r*h)*p,e[8]=(s*i-r*o)*p,e):null},i.multiply=function(t,e,n){n||(n=t);var i=t[0],r=t[1],a=t[2],o=t[3],s=t[4],c=t[5],h=t[6],l=t[7],u=t[8],f=t[9],d=t[10],m=t[11],p=t[12],g=t[13],v=t[14];t=t[15];var w=e[0],y=e[1],x=e[2],b=e[3],_=e[4],T=e[5],k=e[6],C=e[7],E=e[8],A=e[9],R=e[10],S=e[11],D=e[12],M=e[13],X=e[14];return e=e[15],n[0]=w*i+y*s+x*u+b*p,n[1]=w*r+y*c+x*f+b*g,n[2]=w*a+y*h+x*d+b*v,n[3]=w*o+y*l+x*m+b*t,n[4]=_*i+T*s+k*u+C*p,n[5]=_*r+T*c+k*f+C*g,n[6]=_*a+T*h+k*d+C*v,n[7]=_*o+T*l+k*m+C*t,n[8]=E*i+A*s+R*u+S*p,n[9]=E*r+A*c+R*f+S*g,n[10]=E*a+A*h+R*d+S*v,n[11]=E*o+A*l+R*m+S*t,n[12]=D*i+M*s+X*u+e*p,n[13]=D*r+M*c+X*f+e*g,n[14]=D*a+M*h+X*d+e*v,n[15]=D*o+M*l+X*m+e*t,n},i.multiplyVec3=function(t,e,n){n||(n=e);var i=e[0],r=e[1];return e=e[2],n[0]=t[0]*i+t[4]*r+t[8]*e+t[12],n[1]=t[1]*i+t[5]*r+t[9]*e+t[13],n[2]=t[2]*i+t[6]*r+t[10]*e+t[14],n},i.multiplyVec4=function(t,e,n){n||(n=e);var i=e[0],r=e[1],a=e[2];return e=e[3],n[0]=t[0]*i+t[4]*r+t[8]*a+t[12]*e,n[1]=t[1]*i+t[5]*r+t[9]*a+t[13]*e,n[2]=t[2]*i+t[6]*r+t[10]*a+t[14]*e,n[3]=t[3]*i+t[7]*r+t[11]*a+t[15]*e,n},i.translate=function(t,e,n){var i=e[0],r=e[1];if(e=e[2],!n||t==n)return t[12]=t[0]*i+t[4]*r+t[8]*e+t[12],t[13]=t[1]*i+t[5]*r+t[9]*e+t[13],t[14]=t[2]*i+t[6]*r+t[10]*e+t[14],t[15]=t[3]*i+t[7]*r+t[11]*e+t[15],t;var a=t[0],o=t[1],s=t[2],c=t[3],h=t[4],l=t[5],u=t[6],f=t[7],d=t[8],m=t[9],p=t[10],g=t[11];return n[0]=a,n[1]=o,n[2]=s,n[3]=c,n[4]=h,n[5]=l,n[6]=u,n[7]=f,n[8]=d,n[9]=m,n[10]=p,n[11]=g,n[12]=a*i+h*r+d*e+t[12],n[13]=o*i+l*r+m*e+t[13],n[14]=s*i+u*r+p*e+t[14],n[15]=c*i+f*r+g*e+t[15],n},i.scale=function(t,e,n){var i=e[0],r=e[1];return e=e[2],n&&t!=n?(n[0]=t[0]*i,n[1]=t[1]*i,n[2]=t[2]*i,n[3]=t[3]*i,n[4]=t[4]*r,n[5]=t[5]*r,n[6]=t[6]*r,n[7]=t[7]*r,n[8]=t[8]*e,n[9]=t[9]*e,n[10]=t[10]*e,n[11]=t[11]*e,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n):(t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i,t[4]*=r,t[5]*=r,t[6]*=r,t[7]*=r,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t)},i.rotate=function(t,e,n,i){var r=n[0],a=n[1];n=n[2];var o=Math.sqrt(r*r+a*a+n*n);if(!o)return null;1!=o&&(o=1/o,r*=o,a*=o,n*=o);var s=Math.sin(e),c=Math.cos(e),h=1-c;e=t[0],o=t[1];var l=t[2],u=t[3],f=t[4],d=t[5],m=t[6],p=t[7],g=t[8],v=t[9],w=t[10],y=t[11],x=r*r*h+c,b=a*r*h+n*s,_=n*r*h-a*s,T=r*a*h-n*s,k=a*a*h+c,C=n*a*h+r*s,E=r*n*h+a*s;return r=a*n*h-r*s,a=n*n*h+c,i?t!=i&&(i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=e*x+f*b+g*_,i[1]=o*x+d*b+v*_,i[2]=l*x+m*b+w*_,i[3]=u*x+p*b+y*_,i[4]=e*T+f*k+g*C,i[5]=o*T+d*k+v*C,i[6]=l*T+m*k+w*C,i[7]=u*T+p*k+y*C,i[8]=e*E+f*r+g*a,i[9]=o*E+d*r+v*a,i[10]=l*E+m*r+w*a,i[11]=u*E+p*r+y*a,i},i.rotateX=function(t,e,n){var i=Math.sin(e);e=Math.cos(e);var r=t[4],a=t[5],o=t[6],s=t[7],c=t[8],h=t[9],l=t[10],u=t[11];return n?t!=n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]):n=t,n[4]=r*e+c*i,n[5]=a*e+h*i,n[6]=o*e+l*i,n[7]=s*e+u*i,n[8]=r*-i+c*e,n[9]=a*-i+h*e,n[10]=o*-i+l*e,n[11]=s*-i+u*e,n},i.rotateY=function(t,e,n){var i=Math.sin(e);e=Math.cos(e);var r=t[0],a=t[1],o=t[2],s=t[3],c=t[8],h=t[9],l=t[10],u=t[11];return n?t!=n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]):n=t,n[0]=r*e+c*-i,n[1]=a*e+h*-i,n[2]=o*e+l*-i,n[3]=s*e+u*-i,n[8]=r*i+c*e,n[9]=a*i+h*e,n[10]=o*i+l*e,n[11]=s*i+u*e,n},i.rotateZ=function(t,e,n){var i=Math.sin(e);e=Math.cos(e);var r=t[0],a=t[1],o=t[2],s=t[3],c=t[4],h=t[5],l=t[6],u=t[7];return n?t!=n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]):n=t,n[0]=r*e+c*i,n[1]=a*e+h*i,n[2]=o*e+l*i,n[3]=s*e+u*i,n[4]=r*-i+c*e,n[5]=a*-i+h*e,n[6]=o*-i+l*e,n[7]=s*-i+u*e,n},i.frustum=function(t,e,n,r,a,o,s){s||(s=i.create());var c=e-t,h=r-n,l=o-a;return s[0]=2*a/c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*a/h,s[6]=0,s[7]=0,s[8]=(e+t)/c,s[9]=(r+n)/h,s[10]=-(o+a)/l,s[11]=-1,s[12]=0,s[13]=0,s[14]=-(o*a*2)/l,s[15]=0,s},i.perspective=function(t,e,n,r,a){return t=n*Math.tan(t*Math.PI/360),e=t*e,i.frustum(-e,e,-t,t,n,r,a)},i.ortho=function(t,e,n,r,a,o,s){s||(s=i.create());var c=e-t,h=r-n,l=o-a;return s[0]=2/c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/h,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/l,s[11]=0,s[12]=-(t+e)/c,s[13]=-(r+n)/h,s[14]=-(o+a)/l,s[15]=1,s},i.lookAt=function(t,e,n,r){r||(r=i.create());var a=t[0],o=t[1];t=t[2];var s=n[0],c=n[1],h=n[2];n=e[1];var l=e[2];if(a==e[0]&&o==n&&t==l)return i.identity(r);var u,f,d,m;return n=a-e[0],l=o-e[1],e=t-e[2],m=1/Math.sqrt(n*n+l*l+e*e),n*=m,l*=m,e*=m,u=c*e-h*l,h=h*n-s*e,s=s*l-c*n,(m=Math.sqrt(u*u+h*h+s*s))?(m=1/m,u*=m,h*=m,s*=m):s=h=u=0,c=l*s-e*h,f=e*u-n*s,d=n*h-l*u,(m=Math.sqrt(c*c+f*f+d*d))?(m=1/m,c*=m,f*=m,d*=m):d=f=c=0,r[0]=u,r[1]=c,r[2]=n,r[3]=0,r[4]=h,r[5]=f,r[6]=l,r[7]=0,r[8]=s,r[9]=d,r[10]=e,r[11]=0,r[12]=-(u*a+h*o+s*t),r[13]=-(c*a+f*o+d*t),r[14]=-(n*a+l*o+e*t),r[15]=1,r},i.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"};var r={};r.create=function(e){var n=new t(4);return e&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),n},r.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},r.calculateW=function(t,e){var n=t[0],i=t[1],r=t[2];return e&&t!=e?(e[0]=n,e[1]=i,e[2]=r,e[3]=-Math.sqrt(Math.abs(1-n*n-i*i-r*r)),e):(t[3]=-Math.sqrt(Math.abs(1-n*n-i*i-r*r)),t)},r.inverse=function(t,e){return e&&t!=e?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e):(t[0]*=1,t[1]*=1,t[2]*=1,t)},r.length=function(t){var e=t[0],n=t[1],i=t[2];return t=t[3],Math.sqrt(e*e+n*n+i*i+t*t)},r.normalize=function(t,e){e||(e=t);var n=t[0],i=t[1],r=t[2],a=t[3],o=Math.sqrt(n*n+i*i+r*r+a*a);return 0==o?(e[0]=0,e[1]=0,e[2]=0,e[3]=0,e):(o=1/o,e[0]=n*o,e[1]=i*o,e[2]=r*o,e[3]=a*o,e)},r.multiply=function(t,e,n){n||(n=t);var i=t[0],r=t[1],a=t[2];t=t[3];var o=e[0],s=e[1],c=e[2];return e=e[3],n[0]=i*e+t*o+r*c-a*s,n[1]=r*e+t*s+a*o-i*c,n[2]=a*e+t*c+i*s-r*o,n[3]=t*e-i*o-r*s-a*c,n},r.multiplyVec3=function(t,e,n){n||(n=e);var i=e[0],r=e[1],a=e[2];e=t[0];var o=t[1],s=t[2];t=t[3];var c=t*i+o*a-s*r,h=t*r+s*i-e*a,l=t*a+e*r-o*i;return i=-e*i-o*r-s*a,n[0]=c*t+i*-e+h*-s-l*-o,n[1]=h*t+i*-o+l*-e-c*-s,n[2]=l*t+i*-s+c*-o-h*-e,n},r.toMat3=function(t,e){e||(e=n.create());var i=t[0],r=t[1],a=t[2],o=t[3],s=i+i,c=r+r,h=a+a,l=i*s,u=i*c;i*=h;var f=r*c;return r*=h,a*=h,s=o*s,c=o*c,o*=h,e[0]=1-(f+a),e[1]=u-o,e[2]=i+c,e[3]=u+o,e[4]=1-(l+a),e[5]=r-s,e[6]=i-c,e[7]=r+s,e[8]=1-(l+f),e},r.toMat4=function(t,e){e||(e=i.create());var n=t[0],r=t[1],a=t[2],o=t[3],s=n+n,c=r+r,h=a+a,l=n*s,u=n*c;n*=h;var f=r*c;return r*=h,a*=h,s=o*s,c=o*c,o*=h,e[0]=1-(f+a),e[1]=u-o,e[2]=n+c,e[3]=0,e[4]=u+o,e[5]=1-(l+a),e[6]=r-s,e[7]=0,e[8]=n-c,e[9]=r+s,e[10]=1-(l+f),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},r.slerp=function(t,e,n,i){i||(i=t);var r=n;return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]<0&&(r=-1*n),i[0]=1-n*t[0]+r*e[0],i[1]=1-n*t[1]+r*e[1],i[2]=1-n*t[2]+r*e[2],i[3]=1-n*t[3]+r*e[3],i},r.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"},this.mat4=i,this.quat4=r,this.vec3=e}}}),t.UID=i.extend({statics:{_nextID:0,get:function(){return this._nextID++}}}),t.Matrix2D=i.extend({statics:{DEG_TO_RAD:.017453292519943295},ctor:function(t,e,n,i,r,a){return this.a=null==t?1:t,this.b=e||0,this.c=n||0,this.d=null==i?1:i,this.tx=r||0,this.ty=a||0,this},identity:function(){return this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this},appendTransform:function(e,n,i,r,a,o,s,c,h,l,u){if(a%360)var f=a*t.Matrix2D.DEG_TO_RAD,d=Math.cos(f),m=Math.sin(f);else d=1,m=0;return o||s?(o*=t.Matrix2D.DEG_TO_RAD,s*=t.Matrix2D.DEG_TO_RAD,this.append(Math.cos(s),Math.sin(s),-Math.sin(o),Math.cos(o),e,n),this.append(d*i,m*i,-m*r,d*r,0,0)):this.append(d*i,m*i,-m*r,d*r,e,n),(c||h)&&(this.tx-=c*this.a+h*this.c,this.ty-=c*this.b+h*this.d),l&&(this.a*=-1,this.c*=-1),u&&(this.b*=-1,this.d*=-1),this},append:function(t,e,n,i,r,a){var o=this.a,s=this.b,c=this.c,h=this.d;return this.a=t*o+e*c,this.b=t*s+e*h,this.c=n*o+i*c,this.d=n*s+i*h,this.tx=r*o+a*c+this.tx,this.ty=r*s+a*h+this.ty,this},reinitialize:function(t,e,n,i,r,a,o,s,c){return this.initialize(t,e,n,i,r,a),this.alpha=o||1,this.shadow=s,this.compositeOperation=c,this},initialize:function(t,e,n,i,r,a){return null!=t&&(this.a=t),this.b=e||0,this.c=n||0,null!=i&&(this.d=i),this.tx=r||0,this.ty=a||0,this}}),new e.Main}()}(Function("return this")());
    </script>
</body>
</html>
